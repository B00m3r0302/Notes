# Introduction
Portable Executable (PE) is the file format for executables in Windows. A few examples of PE file extensions are:
- .exe
- .dll
- .sys
- .scr
# PE structure
The diagram below shows a simplified structure of a PE file. Every header shown in the image is defined as a data structure that holds the information about the PE file.
![[pe-structure.png]]
# Dos Header (IMAGE_DOS_HEADER)
This first header of a PE file is always prefixed with two bytes:
- 0x4D
- 0x5A
	- These are commonly referred to as 
		- MZ
These bytes represent the DOS header signature, which is used to confirm that the file being parsed or inspected is a valid PE file. THe DOS header is a data structure defined as follows:
```c
typedef struct _IMAGE_DOS_HEADER {          // DOS .EXE header
     WORD e_magic;                          // Magic number
     WORD e_cblp;                           // Bytes on the last page of the file
     WORD e_cp;                             // Pages in file
     WORD e_crlc;                           // Relocations
     WORD e_cparhdr;                        // Size of header in paragraphs
     WORD e_minalloc;                       // Minimum extra paragraphs needed
     WORD e_maxalloc;                       // Maximum extra paragraphs needed
     WORD e_ss;                             // Initial (relative) SS value
     WORD e_sp;                             // Initial SP value
     WORD e_csum;                           // Checksum
     WORD e_ip                              // Initial IP value
     WORD e_cs;                             // Initial (relative) CS value
     WORD e_lfarlc;                         // File address of relocation table
     WORD e_ovno;                           // Overlay number
     WORD e_res[4];                         // Reserved words
     WORD e_oemid;                          // OEM identifier (for e_oeminfo)
     WORD e_oeminfo;                        // OEM information; e_oemid specific
     WORD e_res2[10];                       // Reserved words
     WORD e_lfanew;                         // Offset to the NT header
} IMAGE_DOS_HEADER, *PIMAGE_DOS_HEADER;
```
- The most important members of the struct are 
	- e_magic
		- 2 bytes with a fixed value of 0x5A4D or MZ
	- e_lfanew
		- 4 byte value that holds an offset to the start of the NT header
		- Always located at an offset of 0x3C
# DOS stub
Before moving to the NT header structure, there is the DOS stub which is an error message that prints "This program cannot be run in DOS mode" in case the program is loaded in DOS mode or "Disk Operating Mode."'
- The error message can be changed by the programmer at compile time
- This is not a PE header
# NT header (IMAGE_NT_HEADERS)
The NT header is essential as it incorporates two other image headers:
- FileHeader
- OptionalHeader
these include a large amount of information about the PE file.
Simalarly to the DOS header, the NT header contains a signature member that is used to verify it. Usually the signature element is equal to the "PE" string which is represented by the "0x50" and "0x45" bytes. Since the signature is of datatype "DWORD", the signature will be represented as "0x50450000" which is still "PE", except that it is padded with two null bytes. The NT header can be reached using the "e_lfanew" member inside of the DOS header.
The NT header structure varies depending on the machine's architecture
## 32-bit version:
```c
typedef struct _IMAGE_NT_HEADERS {
     DWORD                   Signature;
     IMAGE_FILE_HEADER       FileHeader;
     IMAGE_OPTIONAL_HEADER32 OptionalHeader;
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;
```
## 64-bit version:
```c
typedef struct _IMAGE_NT_HEADERS {
     DWORD                     Signature;
     IMAGE_FILE_HEADER         FileHeader;
     IMAGE_OPTIONAL_HEADER64   OptionalHeader;
} IMAGE_NT_HEADERS64, *PIMAGE_NT_HEADERS64;
```
- The only difference between the two is the "OptionalHeader" data structure, "IMAGE_OPTIONAL_HEADER32" and "IMAGE_OPTIONAL_HEADER64"
# File header (IMAGE_FILE_HEADER)
This can be accessed from the previous NT header data structure
```c
typedef struct _IMAGE_FILE_HEADER {
    WORD    Machine;
    WORD    NumberOfSections;
    DWORD   TimeDateStamp;
    DWORD   PointerToSymbolTable;
    DWORD   NumberOfSymbols;
    WORD    SizeOfOptionalHeader;
    WORD    Characteristics;
} IMAGE_FILE_HEADER, *PIMAGE_FILE_HEADER
```
The most important struct members are:
- NumberOfSections
	- The number of sections in the PE file
- Characteristics
	- Flags that specify certain attributes about the executable file, such as whether it is a dynamic-link library (DLL) or a console application
- SizeOfOptionalHeader
	- The size of the following optional header
Additional information about the file header can be found at the link below
- https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-image_file_header
# Optional header (IMAGE_OPTIONAL_HEADER)
The optional header is important and although it's called "optional", it's essential for the execution of the PE file. It is referred to as the optional because some file types do not have it. 